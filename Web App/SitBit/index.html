<!DOCTYPE html>
<html>

<head>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>


<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/6.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/6.6.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/6.6.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/6.6.1/firebase-database.js"></script>

 
<script>

  //initializing firebase
  var firebaseConfig = {
    apiKey: "AIzaSyAWv9r-zZGtB1v1ZvP1mXlt-S-Hx_0DjPE",
    authDomain: "striking-figure-236016.firebaseapp.com",
    databaseURL: "https://striking-figure-236016.firebaseio.com",
    projectId: "striking-figure-236016",
    storageBucket: "striking-figure-236016.appspot.com",
    messagingSenderId: "853063308846",
    appID: "1:853063308846:web:246d6ed0eff2faec98b1bf",
  };
  
  firebase.initializeApp(firebaseConfig);
  var ref = firebase.database().ref();

</script>

    
</head>

  <body>

   <form>
    <div class="form-group">
    <label for="idBox"> ID </label>
    <input type="textarea" class="form-control" id="idBox">
    </div>

   <button type="button" class="btn btn-primary" onclick = "loadDatabase()"> Submit </button>
  </form>

  <br><br>

  <button id="sitting" value="button text" onclick = "sitting()" type="button" class="btn btn-primary"> Sitting </button>

  <button id="standing" value="button text" onclick = "standing()" type="button" class="btn btn-primary"> Standing </button>
    

  <script>

    //disable buttons not in use

      // current user ID
    var idBox;

    //get current timestamp (to add for shorter standing arrays - NEED TO FIX TO MAKE SURE THAT WE ARE ADDING AN AGREED UPON "LAST TIME" - 5:00 for example)
    var time = new Date()
    var date = time.getFullYear()+'-'+(time.getMonth()+1)+'-'+time.getDate();
    var currTime = time.getHours() + ":" + time.getMinutes() + ":" + time.getSeconds();
    var lastTime = (date + " " + currTime).split(" ");

      // create reference to firebase, pull current data and display
      function loadDatabase() {

        idBox = document.getElementById("idBox").value;

        ref.on("value", function(snapshot) {
          
          snapshot.forEach(function(childSnapshot) {
            var user = childSnapshot.key;
            var userData = childSnapshot.val();
            var id=userData.id;
            console.log(user);

            //if database is empty, do something else...

            //otherwise, do below functions

            var sitting = userData.sitting;
            var sittingArr = [];
            for (var key in sitting) {
              var value = sitting[key];
              var x = value.split(" ");
              sittingArr.push(x);
            }

            console.log(sittingArr);

            var standing = userData.standing;
            var standingArr = [];
            for (var key in standing) {
              var value = standing[key];
              var x = value.split(" ");
              standingArr.push(x);
            }

        //everytime database loads, for each user, do calculations

        // if standing is less (they forgot to push once, assuming only ONCE)
        while (standingArr.length < sittingArr.length) {
          standingArr.push(lastTime);
          // need to push a new time each time
        }

        console.log(standingArr)

        // in terms of seconds, for now

        var sittingTime = 0
        var standSec = 0;
        var breakTime = 0;
        var startTime = 0;
        var endTime = 0;
        var breakNum = sittingArr.length - 1;


        for (var i = 0; i < sittingArr.length; i++) {
            var sit = sittingArr[i][1];
            var sitTime = sit.split(":")
            var stand = standingArr[i][1];
            var standTime = stand.split(":")

            var sitSec = (parseInt(sitTime[0]) * 3600) + parseInt(sitTime[1] * 60) + parseInt(sitTime[2]); 

            if (i > 0) {
              breakTime += sitSec - standSec;
            }

            var standSec = (parseInt(standTime[0]) * 3600) + parseInt(standTime[1] * 60) + parseInt(standTime[2]);

            if (i == 0) {
              startTime = sitSec;
            }

            if (i == sittingArr.length - 1) {
              endTime = standSec;
            }

            sittingTime += standSec - sitSec;
        }

        // total sedentary time
        console.log(sittingTime);

        //number of breaks
        console.log(breakNum);

        //average break length
        var avgBreakLen = (breakTime/breakNum);
        console.log(avgBreakLen);

        //break frequency
        var freq = (endTime - startTime)/(breakNum+1);
        console.log(freq);

        var dataArr = [];
        dataArr.push(sittingTime);
        dataArr.push(breakNum);
        dataArr.push(avgBreakLen);
        dataArr.push(freq);


        /*push into firebase

        var usersRef = ref.child(user);
        var currRef = usersRef.child("data");
        currRef.push("hey");

        above results in an infinite loop of "hey" being pushed

        */

        });

        }, function (error) {
            console.log("Error: " + error.code);
        });
};


    // add current user info to firebase (sitting)
    function sitting() { 

      //get current time
      var time = new Date()
      var date = time.getFullYear()+'-'+(time.getMonth()+1)+'-'+time.getDate();
      var currTime = time.getHours() + ":" + time.getMinutes() + ":" + time.getSeconds();

      //access child and push new time
      var usersRef = ref.child(idBox);
      var currRef = usersRef.child("sitting");
      currRef.push(date + " " + currTime);

    };

    // add current user info to firebase (standing)
    function standing() { 

      //get current time
      var time = new Date()
      var date = time.getFullYear()+'-'+(time.getMonth()+1)+'-'+time.getDate();
      var currTime = time.getHours() + ":" + time.getMinutes() + ":" + time.getSeconds();

      //access child and push new time
      var usersRef = ref.child(idBox);
      var currRef = usersRef.child("standing");
      currRef.push(date + " " + currTime);

    };

  </script>

  </body>
</html>
